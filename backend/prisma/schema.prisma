generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== ADMIN ====================
model Admin {
  id           Int         @id @default(autoincrement())
  email        String      @unique
  passwordHash String      @map("password_hash")
  name         String?
  role         Role        @default(editor)
  createdAt    DateTime    @default(now()) @map("created_at")
  
  caseStudies  CaseStudy[]
  blogPosts    BlogPost[]
  mediaFiles   Media[]
  assignedBookings Booking[] @relation("AssignedBookings")
  sentMessages Message[]

  @@map("admins")
}

enum Role {
  editor
  super_admin
}

// ==================== CLIENT (NEW) ====================
model Client {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  company      String?
  phone        String?   @db.VarChar(50)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")
  
  bookings     Booking[]
  sentMessages Message[] @relation("ClientMessages")

  @@map("clients")
}

// ==================== SERVICE ====================
model Service {
  id               Int         @id @default(autoincrement())
  title            String
  slug             String      @unique
  type             ServiceType
  category         String?
  icon             String?     @db.VarChar(50)
  shortDescription String?     @db.Text @map("short_description")
  fullDescription  String?     @db.LongText @map("full_description")
  features         Json?
  benefits         Json?
  pricing          Json?
  heroImage        String?     @map("hero_image") @db.VarChar(500)
  faq              Json?
  isActive         Boolean     @default(true) @map("is_active")
  isFeatured       Boolean     @default(false) @map("is_featured")
  order            Int         @default(0)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  
  bookings         Booking[]
  caseStudies      CaseStudy[]

  @@map("services")
}

enum ServiceType {
  web_pentest
  mobile_pentest
  osint
  incident_response
  training
}

// ==================== BOOKING (ENHANCED) ====================
model Booking {
  id               Int            @id @default(autoincrement())
  referenceCode    String         @unique @map("reference_code")
  
  // Client (linked)
  clientId         Int            @map("client_id")
  serviceId        Int            @map("service_id")
  
  // Form details
  priority         String         @default("medium")
  budget           String?
  projectScope     String         @db.Text @map("project_scope")
  timeline         String?
  additionalInfo   String?        @db.Text @map("additional_info")
  
  // Status
  status           BookingStatus  @default(new)
  statusHistory    Json?          @map("status_history")
  
  // Assignment
  assignedTo       Int?           @map("assigned_to")
  
  // Timestamps
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  completedAt      DateTime?      @map("completed_at")
  
  // Relations
  client           Client         @relation(fields: [clientId], references: [id])
  service          Service        @relation(fields: [serviceId], references: [id])
  assignee         Admin?         @relation("AssignedBookings", fields: [assignedTo], references: [id])
  messages         Message[]
  files            BookingFile[]

  @@map("bookings")
}

enum BookingStatus {
  new
  contacted
  in_progress
  testing
  report_ready
  completed
  cancelled
}

// ==================== MESSAGE (NEW) ====================
model Message {
  id          Int       @id @default(autoincrement())
  bookingId   Int       @map("booking_id")
  
  // Sender
  senderType  SenderType @map("sender_type")
  clientId    Int?      @map("client_id")
  adminId     Int?      @map("admin_id")
  
  // Content
  content     String    @db.Text
  
  // Read status
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // Relations
  booking     Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client      Client?   @relation("ClientMessages", fields: [clientId], references: [id])
  admin       Admin?    @relation(fields: [adminId], references: [id])
  attachments MessageAttachment[]

  @@map("messages")
}

enum SenderType {
  client
  admin
}

// ==================== MESSAGE ATTACHMENT (NEW) ====================
model MessageAttachment {
  id          Int      @id @default(autoincrement())
  messageId   Int      @map("message_id")
  fileName    String   @map("file_name")
  originalName String  @map("original_name")
  fileUrl     String   @map("file_url") @db.VarChar(500)
  fileType    String   @map("file_type") @db.VarChar(50)
  fileSize    Int      @map("file_size")
  createdAt   DateTime @default(now()) @map("created_at")
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_attachments")
}

// ==================== BOOKING FILE (NEW) ====================
model BookingFile {
  id          Int      @id @default(autoincrement())
  bookingId   Int      @map("booking_id")
  fileName    String   @map("file_name")
  originalName String  @map("original_name")
  fileUrl     String   @map("file_url") @db.VarChar(500)
  fileType    String   @map("file_type") @db.VarChar(50)
  fileSize    Int      @map("file_size")
  uploadedBy  String   @map("uploaded_by") // "client" or "admin"
  createdAt   DateTime @default(now()) @map("created_at")
  
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_files")
}

// ==================== CASE STUDY (ENHANCED) ====================
model CaseStudy {
  id            Int       @id @default(autoincrement())
  title         String
  slug          String    @unique
  clientName    String?   @map("client_name")
  category      String?
  logo          String?   @db.VarChar(100)
  serviceId     Int?      @map("service_id")
  coverImageUrl String?   @map("cover_image_url") @db.VarChar(500)
  summary       String?   @db.Text
  content       String?   @db.LongText
  impactMetric  String?   @map("impact_metric") @db.VarChar(255)
  stats         Json?
  results       Json?
  tags          Json?
  isPublished   Boolean   @default(false) @map("is_published")
  isFeatured    Boolean   @default(false) @map("is_featured")
  authorId      Int?      @map("author_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  publishedAt   DateTime? @map("published_at")

  author        Admin?    @relation(fields: [authorId], references: [id])
  service       Service?  @relation(fields: [serviceId], references: [id])

  @@map("case_studies")
}

// ==================== DOCUMENT (Legacy - keep for compatibility) ====================
model Document {
  id        Int      @id @default(autoincrement())
  bookingId Int?     @map("booking_id")
  fileUrl   String   @map("file_url") @db.VarChar(500)
  fileName  String?  @map("file_name")
  fileType  String?  @map("file_type") @db.VarChar(50)
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@map("documents")
}

// ==================== HOMEPAGE CONTENT ====================
model HomepageContent {
  id        Int      @id @default(autoincrement())
  sectionKey String  @unique @map("section_key")
  title     String?
  subtitle  String?  @db.Text
  eyebrow   String?
  content   Json
  isActive  Boolean  @default(true) @map("is_active")
  order     Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("homepage_content")
}

// ==================== STATISTIC (ENHANCED) ====================
model Statistic {
  id        Int      @id @default(autoincrement())
  label     String
  value     String
  suffix    String?  @db.VarChar(10)
  icon      String?
  description String? @db.Text
  order     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("statistics")
}

// ==================== CLIENT LOGO (NEW) ====================
model ClientLogo {
  id        Int      @id @default(autoincrement())
  name      String
  logo      String?  @db.VarChar(500)
  category  String?
  website   String?  @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("client_logos")
}

// ==================== TECHNOLOGY (NEW) ====================
model Technology {
  id          Int      @id @default(autoincrement())
  name        String
  icon        String?  @db.VarChar(100)
  category    String?
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("technologies")
}

// ==================== PROCESS STEP (NEW) ====================
model ProcessStep {
  id          Int      @id @default(autoincrement())
  stepNumber  Int      @map("step_number")
  title       String
  description String   @db.Text
  icon        String?  @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("process_steps")
}

// ==================== BLOG ====================
model BlogPost {
  id              Int        @id @default(autoincrement())
  title           String
  slug            String     @unique
  excerpt         String?    @db.Text
  content         String     @db.LongText
  contentJson     Json?      @map("content_json")
  coverImageUrl   String?    @map("cover_image_url") @db.VarChar(500)
  authorId        Int        @map("author_id")
  status          PostStatus @default(draft)
  isPublished     Boolean    @default(false) @map("is_published")
  publishedAt     DateTime?  @map("published_at")
  metaTitle       String?    @map("meta_title") @db.VarChar(255)
  metaDescription String?    @map("meta_description") @db.Text
  metaKeywords    String?    @map("meta_keywords") @db.Text
  viewCount       Int        @default(0) @map("view_count")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  author          Admin          @relation(fields: [authorId], references: [id])
  categories      BlogCategory[] @relation("PostCategories")
  tags            BlogTag[]      @relation("PostTags")

  @@map("blog_posts")
}

enum PostStatus {
  draft
  published
  archived
}

model BlogCategory {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  color       String?    @db.VarChar(20)
  order       Int        @default(0)

  posts       BlogPost[] @relation("PostCategories")

  @@map("blog_categories")
}

model BlogTag {
  id    Int        @id @default(autoincrement())
  name  String     @unique
  slug  String     @unique

  posts BlogPost[] @relation("PostTags")

  @@map("blog_tags")
}

// ==================== MEDIA ====================
model Media {
  id           Int       @id @default(autoincrement())
  fileName     String    @map("file_name")
  originalName String    @map("original_name")
  fileUrl      String    @map("file_url") @db.VarChar(500)
  fileType     MediaType @map("file_type")
  mimeType     String    @map("mime_type") @db.VarChar(100)
  fileSize     Int       @map("file_size")
  width        Int?
  height       Int?
  alt          String?   @db.Text
  uploadedBy   Int       @map("uploaded_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  uploader     Admin     @relation(fields: [uploadedBy], references: [id])

  @@map("media")
}

enum MediaType {
  image
  video
  document
  other
}

// ==================== TESTIMONIAL ====================
model Testimonial {
  id        Int      @id @default(autoincrement())
  clientName String  @map("client_name")
  company   String?
  role      String?
  content   String   @db.Text
  rating    Int?     @default(5)
  avatar    String?  @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")
  isFeatured Boolean @default(false) @map("is_featured")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("testimonials")
}
